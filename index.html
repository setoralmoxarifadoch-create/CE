<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALMOXARIFADO MASTER V12 - J. GUILHERME</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --vinho: #4d0011; }
        body { background-color: #ffffff; font-family: 'Inter', sans-serif; }
        .bg-vinho { background-color: var(--vinho); }
        .piscante-alerta { color: #e11d48; font-weight: 900; animation: blink 0.8s infinite; background: #fff1f2; border: 1px solid #fda4af; padding: 6px; border-radius: 6px; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        /* Esconder canvas de suporte aos gr√°ficos do PDF */
        #canvasSuporte { display: none; }
    </style>
</head>
<body class="p-4">

    <canvas id="canvasSuporte"></canvas>

    <header class="bg-vinho text-white p-6 rounded-xl mb-6 flex justify-between items-center shadow-lg">
        <div>
            <h1 class="text-2xl font-black uppercase italic">Master V12 - J. Guilherme</h1>
            <p id="clock" class="text-xs opacity-60 font-mono"></p>
        </div>
        <div class="flex gap-2">
            <button onclick="gerarRelatorioPDF()" class="bg-white text-vinho px-4 py-2 rounded-lg font-black uppercase text-xs">üìä PDF com Gr√°ficos</button>
            <button onclick="gerarPDFAluguel()" class="bg-amber-500 text-white px-4 py-2 rounded-lg font-black uppercase text-xs">üìã PDF Aluguel</button>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-sm">
                <h3 class="font-black text-gray-700 mb-3 text-xs uppercase italic">‚öôÔ∏è Configurar Setores</h3>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="novo-setor" placeholder="Nome do Setor" class="flex-1 border p-2 rounded text-xs uppercase font-bold outline-none">
                    <button onclick="adicionarSetor()" class="bg-green-600 text-white px-4 rounded font-bold hover:bg-green-700">+</button>
                </div>
                <div id="lista-setores-config" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm border">
                <h3 class="font-black text-vinho mb-3 text-xs uppercase italic">üìù Cadastro de Itens</h3>
                <input type="text" id="p-nome" placeholder="NOME DO MATERIAL" class="w-full border p-2 rounded mb-2 uppercase font-bold text-xs outline-none">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <select id="p-tipo" class="border p-2 rounded text-xs font-bold uppercase">
                        <option value="Insumo">Insumo</option>
                        <option value="Ferramenta">Ferramenta</option>
                    </select>
                    <input type="number" id="p-min" placeholder="M√≠n" class="border p-2 rounded text-center text-xs font-bold">
                </div>
                <input type="number" id="p-qtd" placeholder="Qtd Inicial" class="w-full border p-2 rounded text-center font-bold text-lg mb-3">
                <button onclick="salvarProduto()" class="w-full bg-vinho text-white p-2 rounded font-black uppercase text-xs">Salvar Item</button>
            </div>

            <div class="bg-amber-50 p-5 rounded-xl border border-amber-200">
                <h3 class="font-black text-amber-700 mb-3 text-xs uppercase italic">ü§ù Registro de Aluguel</h3>
                <input type="text" id="alu-item" placeholder="O QUE FOI ALUGADO?" class="w-full border p-2 rounded mb-2 text-xs uppercase font-bold">
                <input type="text" id="alu-empresa" placeholder="FORNECEDOR" class="w-full border p-2 rounded mb-2 text-xs uppercase font-bold">
                <input type="date" id="alu-data" class="w-full border p-2 rounded text-xs mb-3">
                <button onclick="registrarAluguel()" class="w-full bg-amber-600 text-white p-2 rounded font-black uppercase text-xs shadow-md">Salvar Aluguel</button>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-6">
            <div class="bg-white p-5 rounded-xl shadow-xl border-t-4 border-vinho">
                <h3 class="font-black text-vinho mb-3 text-xs uppercase italic">‚ö° Registrar Sa√≠da</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <select id="m-id" class="border p-2 rounded text-xs font-bold uppercase"></select>
                    <select id="m-setor" class="border p-2 rounded text-xs font-bold uppercase"></select>
                    <input type="number" id="m-qtd" placeholder="Qtd" class="border p-2 rounded font-black text-center text-xl outline-none">
                    <input type="text" id="m-func" placeholder="QUEM EST√Å RETIRANDO?" class="border p-2 rounded uppercase text-xs font-bold outline-none">
                </div>
                <button onclick="registrarSaida()" class="w-full mt-3 bg-green-600 text-white p-3 rounded font-black uppercase text-sm shadow-lg">Confirmar Sa√≠da</button>
            </div>

            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 text-[10px] font-black uppercase text-gray-500 border-b">
                        <tr><th class="p-3">Material / Pend√™ncia</th><th class="p-3 text-center">Saldo Atual</th><th class="p-3 text-right">A√ß√£o</th></tr>
                    </thead>
                    <tbody id="lista-estoque"></tbody>
                </table>
            </div>

            <div class="bg-amber-50 rounded-xl border border-amber-200 overflow-hidden shadow-sm">
                <div class="p-3 bg-amber-600 text-white font-black text-xs uppercase text-center">Controle de Itens Alugados</div>
                <table class="w-full text-left text-[10px]">
                    <tbody id="lista-alugados"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let produtos = JSON.parse(localStorage.getItem('j_v12_prods')) || [];
        let posse = JSON.parse(localStorage.getItem('j_v12_posse')) || [];
        let setores = JSON.parse(localStorage.getItem('j_v12_setores')) || ["MONTAGEM", "PINTURA", "MARCENARIA"];
        let alugueis = JSON.parse(localStorage.getItem('j_v12_alugueis')) || [];
        let historicoSaidas = JSON.parse(localStorage.getItem('j_v12_hist')) || [];

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);

        function adicionarSetor() {
            const nome = document.getElementById('novo-setor').value.toUpperCase();
            if(nome && !setores.includes(nome)) { setores.push(nome); salvar(); document.getElementById('novo-setor').value = ''; }
        }
        function removerSetor(nome) { setores = setores.filter(s => s !== nome); salvar(); }

        function registrarAluguel() {
            const item = document.getElementById('alu-item').value.toUpperCase();
            const empresa = document.getElementById('alu-empresa').value.toUpperCase();
            const data = document.getElementById('alu-data').value;
            if(!item || !empresa) return;
            alugueis.unshift({ id: Date.now(), item, empresa, data, status: 'ATIVO' });
            salvar();
        }

        function devolverAluguel(id) {
            const alu = alugueis.find(a => a.id === id);
            alu.status = 'DEVOLVIDO'; alu.dataDev = new Date().toLocaleDateString();
            salvar();
        }

        function salvarProduto() {
            const nome = document.getElementById('p-nome').value.toUpperCase();
            const tipo = document.getElementById('p-tipo').value;
            const min = parseInt(document.getElementById('p-min').value) || 0;
            const qtd = parseInt(document.getElementById('p-qtd').value) || 0;
            if(!nome) return;
            produtos.push({ id: Date.now(), nome, tipo, min, qtd });
            salvar();
            document.getElementById('p-nome').value = ''; document.getElementById('p-qtd').value = '';
        }

        // FUN√á√ÉO PARA EDITAR SALDO DIRETAMENTE (NOVIDADE)
        function ajustarSaldo(id) {
            const novoSaldo = prompt("Digite o novo saldo exato para este item:");
            if (novoSaldo !== null && !isNaN(novoSaldo)) {
                const p = produtos.find(item => item.id === id);
                p.qtd = parseInt(novoSaldo);
                salvar();
            }
        }

        function registrarSaida() {
            const id = document.getElementById('m-id').value;
            const qtd = parseInt(document.getElementById('m-qtd').value);
            const func = document.getElementById('m-func').value.toUpperCase();
            const setor = document.getElementById('m-setor').value;
            if(!id || !qtd || !func) return alert("Preencha tudo!");
            const p = produtos.find(item => item.id == id);
            if(p.qtd < qtd) return alert("SALDO INSUFICIENTE!");
            p.qtd -= qtd;
            
            // Registra para o gr√°fico
            historicoSaidas.push({ data: new Date(), item: p.nome, qtd, func, setor });
            
            if(p.tipo === 'Ferramenta') posse.push({ idPosse: Date.now(), idProd: p.id, nome: p.nome, func: func, qtd: qtd });
            salvar();
            document.getElementById('m-func').value = ''; document.getElementById('m-qtd').value = '';
        }

        function devolverFerramenta(idPosse) {
            const item = posse.find(p => p.idPosse === idPosse);
            const prod = produtos.find(p => p.id === item.idProd);
            if(prod) prod.qtd += item.qtd;
            posse = posse.filter(p => p.idPosse !== idPosse);
            salvar();
        }

        function render() {
            const listaEstoque = document.getElementById('lista-estoque');
            const listaAlugados = document.getElementById('lista-alugados');
            const selectSaida = document.getElementById('m-id');
            const selectSetor = document.getElementById('m-setor');
            const configSetores = document.getElementById('lista-setores-config');

            configSetores.innerHTML = setores.map(s => `<span class="bg-gray-200 px-2 py-1 rounded text-[10px] font-black border flex items-center gap-1">${s}<button onclick="removerSetor('${s}')" class="text-red-600 px-1 font-bold">√ó</button></span>`).join('');
            selectSetor.innerHTML = setores.map(s => `<option value="${s}">${s}</option>`).join('');

            listaEstoque.innerHTML = '';
            selectSaida.innerHTML = '<option value="">SELECIONE O MATERIAL...</option>';
            produtos.forEach(p => {
                const pendentes = posse.filter(item => item.idProd === p.id);
                let alertas = pendentes.map(q => `
                    <div class="piscante-alerta">
                        <span class="text-[10px]">‚ö†Ô∏è COM: ${q.func} (${q.qtd})</span>
                        <button onclick="devolverFerramenta(${q.idPosse})" class="bg-vinho text-white px-2 py-1 rounded text-[8px] font-black">BAIXA ‚úÖ</button>
                    </div>
                `).join('');

                listaEstoque.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3"><div class="font-bold text-gray-800">${p.nome}</div>${alertas}</td>
                        <td class="p-3 text-center">
                           <div class="font-black text-xl ${p.qtd <= p.min ? 'text-red-600' : 'text-vinho'}">${p.qtd}</div>
                           <button onclick="ajustarSaldo(${p.id})" class="text-[9px] text-blue-500 font-bold uppercase underline">Ajustar Saldo</button>
                        </td>
                        <td class="p-3 text-right">
                           <button onclick="produtos=produtos.filter(x=>x.id!=${p.id});salvar();" class="text-gray-300 text-[9px]">Excluir</button>
                        </td>
                    </tr>`;
                selectSaida.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
            });

            listaAlugados.innerHTML = alugueis.map(a => `
                <tr class="border-b ${a.status === 'ATIVO' ? '' : 'opacity-50'}">
                    <td class="p-2 font-bold uppercase">${a.item}</td>
                    <td class="p-2">${a.status === 'ATIVO' ? `<button onclick="devolverAluguel(${a.id})" class="bg-green-600 text-white px-2 py-1 rounded font-black text-[9px]">DEVOLVER</button>` : `OK`}</td>
                </tr>
            `).join('');
        }

        function salvar() {
            localStorage.setItem('j_v12_prods', JSON.stringify(produtos));
            localStorage.setItem('j_v12_posse', JSON.stringify(posse));
            localStorage.setItem('j_v12_setores', JSON.stringify(setores));
            localStorage.setItem('j_v12_alugueis', JSON.stringify(alugueis));
            localStorage.setItem('j_v12_hist', JSON.stringify(historicoSaidas));
            render();
        }

        // --- FUN√á√ïES DE PDF COM GR√ÅFICOS (ITEM 4) ---

        async function gerarRelatorioPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text("RELATORIO MASTER V12 - J. GUILHERME", 14, 20);
            
            // 1. Tabela de Estoque
            doc.autoTable({
                head: [['Item', 'Saldo', 'Status']],
                body: produtos.map(p => [p.nome, p.qtd, p.qtd <= p.min ? 'REPOSICAO' : 'OK']),
                startY: 30
            });

            // 2. Gr√°ficos (Gerados dinamicamente)
            doc.addPage();
            doc.text("ESTATISTICAS DE CONSUMO POR SETOR", 14, 20);
            
            // Dados para o gr√°fico de Setores
            const dadosSetor = {};
            historicoSaidas.forEach(s => dadosSetor[s.setor] = (dadosSetor[s.setor] || 0) + s.qtd);
            
            const imgSetor = await gerarImagemGrafico(Object.keys(dadosSetor), Object.values(dadosSetor), 'Pizza');
            doc.addImage(imgSetor, 'PNG', 15, 30, 80, 80);

            doc.text("TOP FUNCIONARIOS (MAIOR CONSUMO)", 14, 120);
            const dadosFunc = {};
            historicoSaidas.forEach(s => dadosFunc[s.func] = (dadosFunc[s.func] || 0) + s.qtd);
            
            const imgFunc = await gerarImagemGrafico(Object.keys(dadosFunc), Object.values(dadosFunc), 'Barra');
            doc.addImage(imgFunc, 'PNG', 15, 130, 150, 60);

            doc.save(`Relatorio_Inteligente_${new Date().toLocaleDateString()}.pdf`);
        }

        function gerarImagemGrafico(labels, data, tipo) {
            return new Promise(resolve => {
                const ctx = document.getElementById('canvasSuporte').getContext('2d');
                if (window.myChart) window.myChart.destroy();
                
                window.myChart = new Chart(ctx, {
                    type: tipo === 'Pizza' ? 'pie' : 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ['#4d0011', '#16a34a', '#d97706', '#2563eb', '#9333ea', '#db2777']
                        }]
                    },
                    options: {
                        devicePixelRatio: 2,
                        animation: false,
                        plugins: { legend: { display: true } }
                    }
                });
                
                setTimeout(() => { resolve(document.getElementById('canvasSuporte').toDataURL('image/png')); }, 500);
            });
        }

        function gerarPDFAluguel() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.text("ITENS ALUGADOS", 14, 15);
            doc.autoTable({ head: [['Item', 'Empresa', 'Entrada', 'Status']], body: alugueis.map(a => [a.item, a.empresa, a.data, a.status]), startY: 20 });
            doc.save("Alugueis.pdf");
        }

        render();
    </script>
</body>
</html>
