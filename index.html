async function gerarRelatorioSetorGrafico() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const dIni = new Date(document.getElementById('filtro-inicio').value + "T00:00:00").getTime();
    const dFim = new Date(document.getElementById('filtro-fim').value + "T23:59:59").getTime();
    
    // Filtra logs
    const logsPeriodo = logs.filter(l => l.t >= dIni && l.t <= dFim && l.tipo === 'SAIDA'); // Apenas saídas contam como consumo
    
    if(logsPeriodo.length === 0) return alert("Sem dados de SAÍDA no período para gerar gráficos!");

    // --- CÁLCULOS PARA O GRÁFICO ---
    // 1. Agrupar por Setor
    const dadosSetor = {};
    logsPeriodo.forEach(l => {
        dadosSetor[l.setor] = (dadosSetor[l.setor] || 0) + l.qtd;
    });

    // 2. Agrupar por Funcionário (Top 5)
    const dadosFunc = {};
    logsPeriodo.forEach(l => {
        dadosFunc[l.resp] = (dadosFunc[l.resp] || 0) + l.qtd;
    });

    // --- CABEÇALHO DO PDF ---
    // Tenta pegar a logo customizada
    const logoSalva = localStorage.getItem('almox_logo_img');
    if(logoSalva) {
        doc.addImage(logoSalva, 'PNG', 15, 10, 20, 20);
        doc.setFontSize(22); doc.setTextColor(77, 0, 17);
        doc.text("RELATÓRIO DE CONSUMO", 40, 25);
    } else {
        doc.setFillColor(77, 0, 17); doc.rect(0, 0, 210, 30, 'F');
        doc.setTextColor(255); doc.setFontSize(22);
        doc.text("RELATÓRIO DE CONSUMO", 15, 20);
    }
    
    doc.setFontSize(10); doc.setTextColor(100);
    doc.text(`Período: ${document.getElementById('filtro-inicio').value} até ${document.getElementById('filtro-fim').value}`, 15, 40);

    // --- GERAR GRÁFICOS (Truque: Usar o Canvas invisível do HTML) ---
    const canvas = document.getElementById('canvasSetor');
    // Se já existir gráfico anterior, destruir
    if(window.meuGraficoPDF) window.meuGraficoPDF.destroy();

    // Criar Gráfico de Setores
    window.meuGraficoPDF = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: Object.keys(dadosSetor),
            datasets: [{
                data: Object.values(dadosSetor),
                backgroundColor: ['#4d0011', '#e11d48', '#f59e0b', '#10b981', '#3b82f6', '#6366f1']
            }]
        },
        options: { animation: false, responsive: false } // Sem animação para renderizar rápido
    });

    // Esperar um pouquinho para o Chart.js renderizar
    await new Promise(r => setTimeout(r, 500));
    
    // Adicionar Gráfico de Setores ao PDF
    const imgSetor = canvas.toDataURL("image/png");
    doc.setFontSize(14); doc.setTextColor(0);
    doc.text("Consumo por Setor (Qtd Peças)", 15, 55);
    doc.addImage(imgSetor, 'PNG', 15, 60, 80, 80);

    // Destruir e criar Gráfico de Funcionários
    window.meuGraficoPDF.destroy();
    
    // Pegar Top 5 Funcionários
    const topFuncs = Object.entries(dadosFunc).sort((a,b) => b[1] - a[1]).slice(0, 5);
    
    window.meuGraficoPDF = new Chart(canvas, {
        type: 'pie',
        data: {
            labels: topFuncs.map(f => f[0]), // Nomes
            datasets: [{
                data: topFuncs.map(f => f[1]), // Qtds
                backgroundColor: ['#1e293b', '#334155', '#475569', '#64748b', '#94a3b8']
            }]
        },
        options: { animation: false, responsive: false }
    });

    await new Promise(r => setTimeout(r, 500));

    // Adicionar Gráfico de Funcionários ao PDF
    const imgFunc = canvas.toDataURL("image/png");
    doc.text("Top 5 Funcionários que mais retiram", 110, 55);
    doc.addImage(imgFunc, 'PNG', 110, 60, 80, 80);

    // --- TABELA DETALHADA ABAIXO ---
    let yPos = 150;
    doc.text("Detalhamento das Saídas", 15, 145);
    
    const logsTabela = logsPeriodo.sort((a,b) => b.t - a.t); // Mais recentes primeiro
    
    doc.autoTable({
        startY: yPos,
        head: [['Data', 'Setor', 'Produto', 'Qtd', 'Solicitante']],
        body: logsTabela.map(l => [l.data.split(' ')[0], l.setor, l.prod, l.qtd, l.resp]),
        theme: 'grid',
        headStyles: { fillColor: [77, 0, 17] },
        styles: { fontSize: 8 }
    });

    doc.save(`Relatorio_Grafico_Almox.pdf`);
}
