<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA CHIAVARI - MASTER V12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --vinho-chiavari: #4d0011; 
            --dourado-chiavari: #a67c52;
            --bege-fundo: #f4f1ea;
        }
        body { background-color: var(--bege-fundo); font-family: 'Inter', sans-serif; color: #333; }
        
        /* HEADER ESTILO MULTINACIONAL */
        .header-premium {
            background: linear-gradient(135deg, var(--vinho-chiavari) 0%, #2a0009 100%);
            border-bottom: 4px solid var(--dourado-chiavari);
        }

        .piscante-alerta { 
            color: #fff; background: #e11d48; font-weight: 900; 
            animation: blink 0.8s infinite; padding: 8px; border-radius: 6px; 
            margin-top: 5px; display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        
        .card-chiavari { background: white; border-radius: 12px; border: 1px solid #e2d9c8; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .btn-vinho { background-color: var(--vinho-chiavari); color: white; transition: all 0.3s; }
        .btn-vinho:hover { background-color: #6a0018; transform: translateY(-1px); }
        #canvasSuporte { display: none; }
        
        /* Inputs Profissionais */
        input, select { border: 1px solid #d1c7b7 !important; border-radius: 8px !important; }
        input:focus { border-color: var(--dourado-chiavari) !important; ring: 2px var(--dourado-chiavari); }
    </style>
</head>
<body class="p-4 md:p-8">

    <canvas id="canvasSuporte"></canvas>

    <header class="header-premium text-white p-6 rounded-2xl mb-8 flex flex-col md:flex-row justify-between items-center shadow-2xl">
        <div class="flex items-center gap-6">
            <div class="bg-white p-2 rounded-lg shadow-inner">
                <img src="URL_DA_SUA_LOGOMARCA_AQUI" alt="CHIAVARI LOGO" class="h-16 w-auto object-contain">
            </div>
            <div>
                <h1 class="text-3xl font-black tracking-tighter uppercase italic text-[#e5d5bc]">Master V12</h1>
                <p class="text-xs tracking-[0.2em] opacity-80 font-light">GEST√ÉO DE ALMOXARIFADO PREMIUM</p>
            </div>
        </div>
        <div class="flex gap-3 mt-4 md:mt-0">
            <button onclick="gerarRelatorioPDF()" class="bg-[#a67c52] hover:bg-[#8e6a45] text-white px-5 py-2 rounded-full font-bold text-xs shadow-lg uppercase transition">üìä Relat√≥rio Inteligente</button>
            <div id="clock" class="hidden md:block text-right font-mono text-sm opacity-60"></div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-4 space-y-6">
            
            <div class="card-chiavari p-5">
                <h3 class="font-black text-gray-400 mb-4 text-[10px] uppercase tracking-widest border-b pb-2">‚öôÔ∏è Gest√£o de Setores</h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="novo-setor" placeholder="Novo Setor" class="flex-1 p-2 text-xs uppercase font-bold outline-none">
                    <button onclick="adicionarSetor()" class="bg-gray-800 text-white px-4 rounded-lg font-bold hover:bg-black transition">+</button>
                </div>
                <div id="lista-setores-config" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="card-chiavari p-5 border-l-8 border-[#a67c52]">
                <h3 class="font-black text-vinho-chiavari mb-4 text-xs uppercase italic tracking-wider">üìù Cadastro de Patrim√¥nio</h3>
                <input type="text" id="p-nome" placeholder="NOME DO MATERIAL" class="w-full p-3 mb-3 uppercase font-bold text-xs">
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <select id="p-tipo" class="p-3 text-xs font-bold uppercase">
                        <option value="Insumo">Insumo</option>
                        <option value="Ferramenta">Ferramenta</option>
                    </select>
                    <input type="number" id="p-min" placeholder="Estoque M√≠n" class="p-3 text-center text-xs font-bold">
                </div>
                <input type="number" id="p-qtd" placeholder="Qtd Inicial" class="w-full p-4 text-center font-black text-2xl mb-4 bg-gray-50 rounded-xl">
                <button onclick="salvarProduto()" class="w-full btn-vinho p-3 rounded-xl font-black uppercase text-xs shadow-md">Salvar no Sistema</button>
            </div>

            <div class="card-chiavari p-5 bg-[#fffdfa]">
                <h3 class="font-black text-[#8e6a45] mb-4 text-xs uppercase italic tracking-wider">ü§ù Controle de Alugados</h3>
                <input type="text" id="alu-item" placeholder="EQUIPAMENTO" class="w-full p-2 mb-2 text-xs uppercase font-bold">
                <input type="text" id="alu-empresa" placeholder="FORNECEDOR" class="w-full p-2 mb-2 text-xs uppercase font-bold">
                <input type="date" id="alu-data" class="w-full p-2 text-xs mb-3">
                <button onclick="registrarAluguel()" class="w-full bg-[#a67c52] text-white p-2 rounded-lg font-black uppercase text-xs">Registrar Aluguel</button>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-6">
            
            <div class="bg-white p-6 rounded-2xl shadow-2xl border-t-8 border-vinho-chiavari">
                <h3 class="font-black text-vinho-chiavari mb-5 text-sm uppercase flex items-center gap-2">
                    <span class="bg-vinho-chiavari text-white p-1 rounded">‚ö°</span> MOVIMENTA√á√ÉO DE SA√çDA
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-gray-400 uppercase">Material</label>
                        <select id="m-id" class="w-full p-3 text-sm font-bold uppercase bg-gray-50"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-gray-400 uppercase">Setor Destino</label>
                        <select id="m-setor" class="w-full p-3 text-sm font-bold uppercase bg-gray-50"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-gray-400 uppercase">Quantidade</label>
                        <input type="number" id="m-qtd" placeholder="0" class="w-full p-3 font-black text-center text-2xl bg-gray-50">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-black text-gray-400 uppercase">Respons√°vel</label>
                        <input type="text" id="m-func" placeholder="NOME DO FUNCION√ÅRIO" class="w-full p-3 uppercase text-sm font-bold bg-gray-50">
                    </div>
                </div>
                <button onclick="registrarSaida()" class="w-full mt-6 btn-vinho p-4 rounded-xl font-black uppercase text-base shadow-xl">Confirmar Sa√≠da</button>
            </div>

            <div class="card-chiavari overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-[10px] font-black uppercase text-gray-400 border-b">
                        <tr><th class="p-4">Descri√ß√£o do Item / Alertas de Posse</th><th class="p-4 text-center">Saldo Real</th><th class="p-4 text-right">A√ß√µes</th></tr>
                    </thead>
                    <tbody id="lista-estoque"></tbody>
                </table>
            </div>

            <div class="card-chiavari overflow-hidden border-t-4 border-[#a67c52]">
                <div class="p-3 bg-[#fcf9f5] font-black text-[11px] text-[#8e6a45] uppercase tracking-tighter italic">Equipamentos de Terceiros</div>
                <table class="w-full text-left text-[10px]">
                    <tbody id="lista-alugados"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- GAVETAS LIMPAS V12 ---
        let produtos = JSON.parse(localStorage.getItem('ch_v12_p')) || [];
        let posse = JSON.parse(localStorage.getItem('ch_v12_po')) || [];
        let setores = JSON.parse(localStorage.getItem('ch_v12_s')) || ["MONTAGEM", "EVENTOS", "MANUTEN√á√ÉO"];
        let alugueis = JSON.parse(localStorage.getItem('ch_v12_a')) || [];
        let historicoSaidas = JSON.parse(localStorage.getItem('ch_v12_h')) || [];

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);

        function adicionarSetor() {
            const nome = document.getElementById('novo-setor').value.toUpperCase();
            if(nome && !setores.includes(nome)) { setores.push(nome); salvar(); document.getElementById('novo-setor').value = ''; }
        }
        function removerSetor(nome) { setores = setores.filter(s => s !== nome); salvar(); }

        function registrarAluguel() {
            const item = document.getElementById('alu-item').value.toUpperCase();
            const empresa = document.getElementById('alu-empresa').value.toUpperCase();
            const data = document.getElementById('alu-data').value;
            if(!item || !empresa) return;
            alugueis.unshift({ id: Date.now(), item, empresa, data, status: 'ATIVO' });
            salvar();
        }

        function devolverAluguel(id) {
            const alu = alugueis.find(a => a.id === id);
            alu.status = 'DEVOLVIDO'; alu.dataDev = new Date().toLocaleDateString();
            salvar();
        }

        function ajustarSaldo(id) {
            const novoSaldo = prompt("AJUSTE DE INVENT√ÅRIO - Digite o saldo exato:");
            if (novoSaldo !== null && !isNaN(novoSaldo)) {
                const p = produtos.find(item => item.id === id);
                p.qtd = parseInt(novoSaldo);
                salvar();
            }
        }

        function salvarProduto() {
            const nome = document.getElementById('p-nome').value.toUpperCase();
            const tipo = document.getElementById('p-tipo').value;
            const min = parseInt(document.getElementById('p-min').value) || 0;
            const qtd = parseInt(document.getElementById('p-qtd').value) || 0;
            if(!nome) return;
            produtos.push({ id: Date.now(), nome, tipo, min, qtd });
            salvar();
            document.getElementById('p-nome').value = ''; document.getElementById('p-qtd').value = '';
        }

        function registrarSaida() {
            const id = document.getElementById('m-id').value;
            const qtd = parseInt(document.getElementById('m-qtd').value);
            const func = document.getElementById('m-func').value.toUpperCase();
            const setor = document.getElementById('m-setor').value;
            if(!id || !qtd || !func) return alert("Erro: Preencha todos os campos.");
            
            const p = produtos.find(item => item.id == id);
            if(p.qtd < qtd) return alert("SALDO INSUFICIENTE NO SISTEMA.");
            
            p.qtd -= qtd;
            historicoSaidas.push({ data: new Date(), item: p.nome, qtd, func, setor });
            if(p.tipo === 'Ferramenta') posse.push({ idPosse: Date.now(), idProd: p.id, nome: p.nome, func: func, qtd: qtd });
            
            salvar();
            document.getElementById('m-func').value = ''; document.getElementById('m-qtd').value = '';
        }

        function devolverFerramenta(idPosse) {
            const item = posse.find(p => p.idPosse === idPosse);
            const prod = produtos.find(p => p.id === item.idProd);
            if(prod) prod.qtd += item.qtd;
            posse = posse.filter(p => p.idPosse !== idPosse);
            salvar();
        }

        function render() {
            const listaEstoque = document.getElementById('lista-estoque');
            const listaAlugados = document.getElementById('lista-alugados');
            const selectSaida = document.getElementById('m-id');
            const selectSetor = document.getElementById('m-setor');
            const configSetores = document.getElementById('lista-setores-config');

            configSetores.innerHTML = setores.map(s => `<span class="bg-white px-2 py-1 rounded-lg text-[10px] font-black border flex items-center gap-1 shadow-sm">${s}<button onclick="removerSetor('${s}')" class="text-red-600 font-bold ml-1">√ó</button></span>`).join('');
            selectSetor.innerHTML = setores.map(s => `<option value="${s}">${s}</option>`).join('');

            listaEstoque.innerHTML = '';
            selectSaida.innerHTML = '<option value="">BUSCAR MATERIAL...</option>';
            produtos.forEach(p => {
                const pendentes = posse.filter(item => item.idProd === p.id);
                let alertas = pendentes.map(q => `
                    <div class="piscante-alerta">
                        <span class="text-[10px]">‚ö†Ô∏è EM POSSE: ${q.func} (${q.qtd})</span>
                        <button onclick="devolverFerramenta(${q.idPosse})" class="bg-white text-red-600 px-3 py-1 rounded-full text-[8px] font-black uppercase">Receber ‚úÖ</button>
                    </div>
                `).join('');

                listaEstoque.innerHTML += `
                    <tr class="border-b">
                        <td class="p-4"><div class="font-black text-gray-800 text-sm tracking-tight">${p.nome}</div>${alertas}</td>
                        <td class="p-4 text-center">
                           <div class="font-black text-2xl ${p.qtd <= p.min ? 'text-red-600' : 'text-vinho-chiavari'}">${p.qtd}</div>
                           <button onclick="ajustarSaldo(${p.id})" class="text-[9px] text-[#a67c52] font-black uppercase underline tracking-tighter">Ajustar Saldo</button>
                        </td>
                        <td class="p-4 text-right">
                           <button onclick="if(confirm('Excluir?')){produtos=produtos.filter(x=>x.id!=${p.id});salvar();}" class="text-gray-300 text-[10px] hover:text-red-500 transition">Excluir</button>
                        </td>
                    </tr>`;
                selectSaida.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
            });

            listaAlugados.innerHTML = alugueis.map(a => `
                <tr class="border-b ${a.status === 'ATIVO' ? '' : 'opacity-40'}">
                    <td class="p-3 font-bold uppercase text-gray-600">${a.item} (${a.empresa})</td>
                    <td class="p-3 text-right">
                        ${a.status === 'ATIVO' ? `<button onclick="devolverAluguel(${a.id})" class="bg-gray-800 text-white px-3 py-1 rounded text-[8px] font-black uppercase">Dar Baixa</button>` : `DEVOLVIDO`}
                    </td>
                </tr>
            `).join('');
        }

        function salvar() {
            localStorage.setItem('ch_v12_p', JSON.stringify(produtos));
            localStorage.setItem('ch_v12_po', JSON.stringify(posse));
            localStorage.setItem('ch_v12_s', JSON.stringify(setores));
            localStorage.setItem('ch_v12_a', JSON.stringify(alugueis));
            localStorage.setItem('ch_v12_h', JSON.stringify(historicoSaidas));
            render();
        }

        // --- PDF COM GR√ÅFICOS CHIAVARI ---
        async function gerarRelatorioPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFillColor(77, 0, 17); doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.text("CHIAVARI - RELAT√ìRIO OPERACIONAL", 14, 25);
            
            doc.setTextColor(0, 0, 0); doc.autoTable({ head: [['MATERIAL', 'SALDO', 'CONDI√á√ÉO']], body: produtos.map(p => [p.nome, p.qtd, p.qtd <= p.min ? 'REPOSI√á√ÉO' : 'EST√ÅVEL']), startY: 50 });

            doc.addPage(); doc.text("CONSUMO POR SETOR (%)", 14, 20);
            const dSetor = {}; historicoSaidas.forEach(s => dSetor[s.setor] = (dSetor[s.setor] || 0) + s.qtd);
            const imgSetor = await gerarImgGraf(Object.keys(dSetor), Object.values(dSetor), 'pie');
            doc.addImage(imgSetor, 'PNG', 15, 30, 80, 80);

            doc.text("TOP CONSUMIDORES (FUNCION√ÅRIOS)", 14, 130);
            const dFunc = {}; historicoSaidas.forEach(s => dFunc[s.func] = (dFunc[s.func] || 0) + s.qtd);
            const imgFunc = await gerarImgGraf(Object.keys(dFunc), Object.values(dFunc), 'bar');
            doc.addImage(imgFunc, 'PNG', 15, 140, 160, 70);

            doc.save("Relatorio_Chiavari_Master.pdf");
        }

        function gerarImgGraf(labels, data, type) {
            return new Promise(resolve => {
                const ctx = document.getElementById('canvasSuporte').getContext('2d');
                if (window.myChart) window.myChart.destroy();
                window.myChart = new Chart(ctx, {
                    type: type, data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#4d0011', '#a67c52', '#d1c7b7', '#2a0009', '#5c4033'] }] },
                    options: { animation: false, devicePixelRatio: 2 }
                });
                setTimeout(() => resolve(document.getElementById('canvasSuporte').toDataURL('image/png')), 600);
            });
        }

        render();
    </script>
</body>
</html>
