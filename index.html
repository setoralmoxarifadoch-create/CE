<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALMOXARIFADO MASTER V10 - J. GUILHERME</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --vinho: #4d0011; }
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .bg-vinho { background-color: var(--vinho); }
        .text-vinho { color: var(--vinho); }
        .piscante-alerta { color: #e11d48; font-weight: 900; animation: blink 0.8s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .card-dash { background: white; padding: 20px; border-radius: 16px; border-bottom: 4px solid var(--vinho); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="p-4 pb-20">

    <header class="bg-vinho text-white p-6 rounded-3xl mb-8 flex flex-col md:flex-row justify-between items-center shadow-2xl gap-4">
        <div>
            <h1 class="text-2xl font-black uppercase italic">Master Intelligence V10</h1>
            <p id="clock" class="text-xs opacity-60 font-mono"></p>
        </div>
        <div class="flex gap-2">
            <button onclick="gerarRelatorioPDF()" class="bg-white text-vinho px-4 py-2 rounded-xl font-black uppercase text-[10px] shadow-lg">üìä PDF Estoque</button>
            <button onclick="gerarPDFAluguel()" class="bg-amber-500 text-white px-4 py-2 rounded-xl font-black uppercase text-[10px] shadow-lg">üìã PDF Aluguel</button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="card-dash text-center">
            <p class="text-gray-400 text-[10px] font-black uppercase">Reposi√ß√£o</p>
            <h2 id="dash-criticos" class="text-2xl font-black text-red-600">0</h2>
        </div>
        <div class="card-dash text-center">
            <p class="text-gray-400 text-[10px] font-black uppercase">Pend√™ncias Equipe</p>
            <h2 id="dash-posse" class="text-2xl font-black text-blue-600">0</h2>
        </div>
        <div class="card-dash text-center border-amber-500">
            <p class="text-amber-600 text-[10px] font-black uppercase">Itens Alugados</p>
            <h2 id="dash-aluguel" class="text-2xl font-black text-amber-600">0</h2>
        </div>
        <div class="card-dash text-center">
            <p class="text-gray-400 text-[10px] font-black uppercase">Saldo Total</p>
            <h2 id="dash-total" class="text-2xl font-black text-green-600">0</h2>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-4 space-y-6">
            
            <div class="bg-white p-6 rounded-3xl shadow-sm border">
                <h3 class="font-black text-vinho mb-4 text-xs uppercase italic">‚öôÔ∏è Gest√£o de Setores</h3>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="novo-setor" placeholder="NOME DO SETOR" class="flex-1 border p-2 rounded-lg text-xs uppercase font-bold">
                    <button onclick="adicionarSetor()" class="bg-green-600 text-white px-4 rounded-lg font-bold">+</button>
                </div>
                <div id="lista-setores-config" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border">
                <h3 class="font-black text-vinho mb-4 text-xs uppercase italic">üìù Cadastro de Material</h3>
                <input type="text" id="p-nome" placeholder="NOME DO MATERIAL" class="w-full border p-3 rounded-xl mb-3 outline-none uppercase font-bold text-xs">
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <select id="p-tipo" class="border p-3 rounded-xl bg-gray-50 text-xs font-bold uppercase">
                        <option value="Insumo">Insumo</option>
                        <option value="Ferramenta">Ferramenta</option>
                    </select>
                    <input type="number" id="p-min" placeholder="M√≠nimo" class="border p-3 rounded-xl text-center text-xs font-bold">
                </div>
                <input type="number" id="p-qtd" placeholder="Qtd Inicial" class="w-full border p-3 rounded-xl text-center font-bold text-lg mb-4">
                <button onclick="salvarProduto()" class="w-full bg-vinho text-white p-3 rounded-2xl font-black uppercase text-xs">Cadastrar</button>
            </div>

            <div class="bg-amber-50 p-6 rounded-3xl border border-amber-200">
                <h3 class="font-black text-amber-700 mb-4 text-xs uppercase italic">ü§ù Registrar Aluguel</h3>
                <input type="text" id="alu-item" placeholder="PRODUTO ALUGADO" class="w-full border p-2 rounded-lg mb-2 text-xs uppercase font-bold">
                <input type="text" id="alu-empresa" placeholder="EMPRESA / FORNECEDOR" class="w-full border p-2 rounded-lg mb-2 text-xs uppercase">
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div class="text-[9px] font-bold">DATA ENTRADA:</div>
                    <div class="text-[9px] font-bold">PREVIS√ÉO DEVOLU√á√ÉO:</div>
                    <input type="date" id="alu-data-in" class="border p-2 rounded-lg text-xs">
                    <input type="date" id="alu-data-out" class="border p-2 rounded-lg text-xs">
                </div>
                <button onclick="registrarAluguel()" class="w-full bg-amber-600 text-white p-3 rounded-xl font-black uppercase text-xs shadow-md">Registrar Loca√ß√£o</button>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-6">
            
            <div class="bg-white p-6 rounded-3xl shadow-xl border-t-8 border-vinho">
                <h3 class="font-black text-vinho mb-4 text-xs uppercase italic">‚ö° Registrar Sa√≠da</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <select id="m-id" class="border p-3 rounded-xl text-xs font-bold uppercase"></select>
                    <select id="m-setor" class="border p-3 rounded-xl text-xs font-bold uppercase"></select>
                    <input type="number" id="m-qtd" placeholder="Qtd" class="border p-3 rounded-xl font-black text-center text-xl">
                    <input type="text" id="m-func" placeholder="NOME DO FUNCION√ÅRIO" class="border p-3 rounded-xl uppercase text-xs font-bold">
                </div>
                <button onclick="registrarSaida()" class="w-full mt-4 bg-green-600 text-white p-4 rounded-2xl font-black uppercase shadow-lg">Confirmar Sa√≠da</button>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                <div class="p-4 bg-gray-50 border-b font-black text-xs text-gray-500 uppercase">Estoque e Pend√™ncias</div>
                <table class="w-full text-left">
                    <thead class="text-[10px] uppercase bg-gray-100 font-black">
                        <tr><th class="p-4">Material</th><th class="p-4 text-center">Saldo</th><th class="p-4 text-right">A√ß√£o</th></tr>
                    </thead>
                    <tbody id="lista-estoque"></tbody>
                </table>
            </div>

            <div class="bg-amber-50 rounded-3xl shadow-sm border border-amber-200 overflow-hidden">
                <div class="p-4 bg-amber-600 text-white font-black text-xs uppercase">Controle de Alugados (Ativos e Hist√≥rico)</div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-[10px]">
                        <thead>
                            <tr class="bg-amber-100 uppercase">
                                <th class="p-2">Item</th><th class="p-2">Empresa</th><th class="p-2">Entrada</th><th class="p-2">Devolu√ß√£o</th><th class="p-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="lista-aluguel"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // TRANCADO: VARI√ÅVEIS BASE
        let produtos = JSON.parse(localStorage.getItem('almox_v10_prods')) || [];
        let logs = JSON.parse(localStorage.getItem('almox_v10_logs')) || [];
        let posse = JSON.parse(localStorage.getItem('almox_v10_posse')) || [];
        let setores = JSON.parse(localStorage.getItem('almox_v10_setores')) || ["MONTAGEM", "SHOWROOM", "PINTURA", "MARCENARIA"];
        let alugueis = JSON.parse(localStorage.getItem('almox_v10_aluguel')) || [];

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);

        // 1. FUN√á√ïES DE SETOR
        function adicionarSetor() {
            const nome = document.getElementById('novo-setor').value.toUpperCase();
            if(nome && !setores.includes(nome)) {
                setores.push(nome);
                salvar();
                document.getElementById('novo-setor').value = '';
            }
        }
        function removerSetor(nome) {
            setores = setores.filter(s => s !== nome);
            salvar();
        }

        // 2. FUN√á√ïES DE ALUGUEL
        function registrarAluguel() {
            const item = document.getElementById('alu-item').value.toUpperCase();
            const empresa = document.getElementById('alu-empresa').value.toUpperCase();
            const dataIn = document.getElementById('alu-data-in').value;
            const dataOut = document.getElementById('alu-data-out').value;
            if(!item || !empresa || !dataIn) return alert("Preencha os dados do aluguel!");
            
            alugueis.unshift({ id: Date.now(), item, empresa, dataIn, dataOut, status: 'ATIVO' });
            salvar();
            document.getElementById('alu-item').value = ''; document.getElementById('alu-empresa').value = '';
        }
        function finalizarAluguel(id) {
            const alu = alugueis.find(a => a.id === id);
            alu.status = 'DEVOLVIDO';
            alu.dataFinalizado = new Date().toLocaleDateString();
            salvar();
        }

        // FUN√á√ïES PADR√ÉO (TRANCADAS E ATUALIZADAS)
        function salvarProduto() {
            const nome = document.getElementById('p-nome').value.toUpperCase();
            const tipo = document.getElementById('p-tipo').value;
            const min = parseInt(document.getElementById('p-min').value) || 0;
            const qtd = parseInt(document.getElementById('p-qtd').value) || 0;
            if(!nome) return;
            produtos.push({ id: Date.now(), nome, tipo, min, qtd });
            salvar();
            document.getElementById('p-nome').value = ''; document.getElementById('p-qtd').value = '';
        }

        function registrarSaida() {
            const id = document.getElementById('m-id').value;
            const qtd = parseInt(document.getElementById('m-qtd').value);
            const func = document.getElementById('m-func').value.toUpperCase();
            const setor = document.getElementById('m-setor').value;
            if(!id || !qtd || !func) return alert("Preencha tudo!");
            const p = produtos.find(item => item.id == id);
            if(p.qtd < qtd) return alert("Saldo insuficiente!");
            p.qtd -= qtd;
            if(p.tipo === 'Ferramenta') posse.push({ idPosse: Date.now(), idProd: p.id, nome: p.nome, func: func, qtd: qtd });
            logs.unshift({ data: new Date().toLocaleString(), tipo: 'SA√çDA', prod: p.nome, qtd, resp: `${func} (${setor})` });
            salvar();
            document.getElementById('m-func').value = ''; document.getElementById('m-qtd').value = '';
        }

        function devolverFerramenta(idPosse) {
            const item = posse.find(p => p.idPosse === idPosse);
            const prod = produtos.find(p => p.id === item.idProd);
            if(prod) prod.qtd += item.qtd;
            posse = posse.filter(p => p.idPosse !== idPosse);
            logs.unshift({ data: new Date().toLocaleString(), tipo: 'DEVOLU√á√ÉO', prod: item.nome, qtd: item.qtd, resp: item.func });
            salvar();
        }

        function render() {
            const listaEstoque = document.getElementById('lista-estoque');
            const listaAluguel = document.getElementById('lista-aluguel');
            const selectSaida = document.getElementById('m-id');
            const selectSetor = document.getElementById('m-setor');
            const configSetores = document.getElementById('lista-setores-config');

            // Render Setores
            configSetores.innerHTML = setores.map(s => `
                <span class="bg-gray-100 px-2 py-1 rounded text-[10px] font-bold border flex items-center gap-2">
                    ${s} <button onclick="removerSetor('${s}')" class="text-red-500 font-black">√ó</button>
                </span>
            `).join('');
            selectSetor.innerHTML = setores.map(s => `<option value="${s}">${s}</option>`).join('');

            // Render Estoque com Alerta de Posse
            listaEstoque.innerHTML = '';
            selectSaida.innerHTML = '<option value="">MATERIAL...</option>';
            produtos.forEach(p => {
                const pendentes = posse.filter(item => item.idProd === p.id);
                let alertas = pendentes.map(q => `
                    <div class="piscante-alerta text-[10px] flex justify-between bg-red-50 p-2 mt-1 rounded border border-red-200">
                        <span>‚ö†Ô∏è EM POSSE DE: ${q.func} (${q.qtd})</span>
                        <button onclick="devolverFerramenta(${q.idPosse})" class="bg-vinho text-white px-2 py-1 rounded text-[8px] font-black">DAR BAIXA (DEVOLVEU)</button>
                    </div>
                `).join('');

                listaEstoque.innerHTML += `
                    <tr class="border-b">
                        <td class="p-4">
                            <div class="font-bold text-gray-700">${p.nome}</div>
                            ${alertas}
                        </td>
                        <td class="p-4 text-center font-black text-xl ${p.qtd <= p.min ? 'text-red-600' : 'text-vinho'}">${p.qtd}</td>
                        <td class="p-4 text-right">
                            <button onclick="produtos=produtos.filter(x=>x.id!=${p.id});salvar();" class="text-gray-300 text-[10px]">Excluir</button>
                        </td>
                    </tr>`;
                selectSaida.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
            });

            // Render Aluguel
            listaAluguel.innerHTML = alugueis.map(a => `
                <tr class="border-b ${a.status === 'ATIVO' ? 'bg-white' : 'bg-gray-50 opacity-60'}">
                    <td class="p-2 font-bold">${a.item}</td>
                    <td class="p-2">${a.empresa}</td>
                    <td class="p-2">${a.dataIn}</td>
                    <td class="p-2">${a.dataOut || '--'}</td>
                    <td class="p-2">
                        ${a.status === 'ATIVO' 
                            ? `<button onclick="finalizarAluguel(${a.id})" class="bg-green-600 text-white px-2 py-1 rounded font-black">DEVOLVER</button>` 
                            : `<span class="text-gray-500 font-bold">FEITO (${a.dataFinalizado})</span>`}
                    </td>
                </tr>
            `).join('');

            document.getElementById('dash-criticos').innerText = produtos.filter(p => p.qtd <= p.min).length;
            document.getElementById('dash-posse').innerText = posse.length;
            document.getElementById('dash-total').innerText = produtos.reduce((acc, p) => acc + p.qtd, 0);
            document.getElementById('dash-aluguel').innerText = alugueis.filter(a => a.status === 'ATIVO').length;
        }

        function salvar() {
            localStorage.setItem('almox_v10_prods', JSON.stringify(produtos));
            localStorage.setItem('almox_v10_logs', JSON.stringify(logs));
            localStorage.setItem('almox_v10_posse', JSON.stringify(posse));
            localStorage.setItem('almox_v10_setores', JSON.stringify(setores));
            localStorage.setItem('almox_v10_aluguel', JSON.stringify(alugueis));
            render();
        }

        function gerarRelatorioPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("RELATORIO DE ESTOQUE - MASTER V10", 14, 15);
            const data = produtos.map(p => [p.nome, p.qtd, p.qtd <= p.min ? 'REPOR' : 'OK']);
            doc.autoTable({ head: [['Item', 'Saldo', 'Status']], body: data, startY: 25 });
            doc.save(`Estoque_${new Date().toLocaleDateString()}.pdf`);
        }

        function gerarPDFAluguel() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("RELATORIO DE ITENS ALUGADOS", 14, 15);
            const data = alugueis.map(a => [a.item, a.empresa, a.dataIn, a.dataOut, a.status]);
            doc.autoTable({ head: [['Item', 'Fornecedor', 'Entrada', 'Previsao', 'Status']], body: data, startY: 25 });
            doc.save(`Alugueis_${new Date().toLocaleDateString()}.pdf`);
        }

        render();
    </script>
</body>
</html>
